<!DOCTYPE html>
<html>
<head>
    <title>JSONP Test - Dr. Janak Appointments</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .log { background: #252526; padding: 10px; margin: 10px 0; border-left: 3px solid #007acc; }
        .error { border-color: #f48771; }
        .success { border-color: #89d185; }
        button { padding: 10px 20px; font-size: 14px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <h1>ðŸ§ª JSONP Connectivity Test</h1>
    <p>Testing connection to Google Apps Script with JSONP...</p>
    
    <div>
        <button onclick="testDirect()">1. Test Direct GET</button>
        <button onclick="testJSONP()">2. Test JSONP</button>
        <button onclick="testCreate()">3. Test Create Appointment</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="logs"></div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbytQnaTF9Ml70w7cgigKxxB-0R9HbbHUmgVK6-w91TD-ctzyH-POsgPp5fVUT_rmyfD/exec';
        
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').prepend(div);
            console.log(message);
        }

        function testDirect() {
            log('Testing direct fetch (will fail with CORS but shows if URL is valid)...');
            fetch(GAS_URL)
                .then(response => {
                    log(`âœ… URL is reachable! Status: ${response.status}`, 'success');
                    return response.text();
                })
                .then(text => {
                    log(`Response preview: ${text.substring(0, 200)}...`, 'success');
                })
                .catch(error => {
                    log(`âŒ ${error.message}`, 'error');
                });
        }

        function testJSONP() {
            log('Testing JSONP request...');
            const callbackName = 'test_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                log(`âœ… JSONP SUCCESS! Received: ${JSON.stringify(data, null, 2)}`, 'success');
                if (script.parentNode) script.parentNode.removeChild(script);
                delete window[callbackName];
            };
            
            script.onerror = function() {
                log(`âŒ JSONP FAILED: Script could not load. Apps Script may not be deployed or callback not supported.`, 'error');
                if (script.parentNode) script.parentNode.removeChild(script);
                delete window[callbackName];
            };
            
            const testUrl = `${GAS_URL}?callback=${callbackName}`;
            log(`Loading: ${testUrl}`);
            script.src = testUrl;
            document.body.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    log('âŒ JSONP TIMEOUT: No response after 10 seconds', 'error');
                }
            }, 10000);
        }

        function testCreate() {
            log('Testing create appointment via JSONP...');
            const callbackName = 'create_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                log(`âœ… CREATE SUCCESS! Response: ${JSON.stringify(data, null, 2)}`, 'success');
                if (script.parentNode) script.parentNode.removeChild(script);
                delete window[callbackName];
            };
            
            script.onerror = function() {
                log(`âŒ CREATE FAILED: Script could not load`, 'error');
                if (script.parentNode) script.parentNode.removeChild(script);
                delete window[callbackName];
            };
            
            const params = new URLSearchParams({
                action: 'create',
                patientName: 'JSONP Test Patient',
                phone: '9999999999',
                date: '2025-12-07',
                time: '10:00',
                notes: 'Test from JSONP diagnostic',
                callback: callbackName
            });
            
            const testUrl = `${GAS_URL}?${params.toString()}`;
            log(`Loading: ${testUrl.substring(0, 150)}...`);
            script.src = testUrl;
            document.body.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    log('âŒ CREATE TIMEOUT: No response after 10 seconds', 'error');
                }
            }, 10000);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Auto-run initial test
        setTimeout(() => {
            log('=== Auto-running initial tests ===');
            testDirect();
            setTimeout(testJSONP, 1000);
        }, 500);
    </script>
</body>
</html>
